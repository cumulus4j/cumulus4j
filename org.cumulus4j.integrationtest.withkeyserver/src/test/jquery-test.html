<html>
<head>
	<title>Cumulus4j - jQuery Test</title>
	<style type="text/css">
		body,td,a,p{font-family:arial,sans-serif}
		p{margin: 4px;}
		#log{font-size: smaller; margin-top: 16px}
	</style>
</head>
<body>

<table>
	<tr>
		<td>Username: </td>
		<td><input type="text" id="username" value="devil"/></td>
	</tr>
	<tr>
		<td>Password: </td>
		<td><input type="password" id="password" value="testtesttest"/></td>
	</tr>
	<tr>
		<td colspan="2">
			<a id="trigger" href="javascript:void(0)">Start Test.</a>
		</td>
</table>

<div id="log">
</div>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js"></script>
<script type="text/javascript" src="jquery.base64.min.js"></script>
<script type="text/javascript" src="jquery.json-2.3.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function(){
	jQuery("#trigger").click(function(event){
		function log(str) {
			jQuery("#log").append("<p>" + str + "</p>");
		}
		function make_base_auth(user, password) {
		  var tok = user + ':' + password;
		  var hash = jQuery.base64.encode(tok);
		  return "Basic " + hash;
		}
		function jsonAjax(opts) {
			log(opts.type + " " + opts.url);
			headers = { "Accept": "application/json" }; 
			if (opts.username) {
				headers.Authorization = make_base_auth(opts.username, opts.password);
			}
			jQuery.ajax({
				url: opts.url,
				type: opts.type,
				contentType: "application/json",
				headers: headers,
				processData: false,
				dataType: "json",
				data: jQuery.toJSON(opts.data),
				success: opts.success,
				error: opts.error
			});
		}

		function doInUnlockedSession(opts) {
			// ### init: ###
			var initData = {"keyActivityPeriodMSec":opts.keyActivityPeriodMSec,"keyStorePeriodMSec":opts.keyStorePeriodMSec};
			jsonAjax({
				url: opts.keyManagerUrl + "/DateDependentKeyStrategy/" + encodeURIComponent(opts.keyStoreId) + "/init",
				type: "POST",
				data: initData,
				username: opts.username,
				password: opts.password,
				success: function(data) {
					log("Success: " + jQuery.toJSON(data));
					
					// ### register app server: ###
					var appServerData = {"appServerBaseURL":opts.appServerBaseURL,"appServerID":opts.appServerID}
					jsonAjax({
						url: opts.keyManagerUrl + "/AppServer/" + encodeURIComponent(opts.keyStoreId),
						type: "POST",
						data: appServerData,
						username: opts.username,
						password: opts.password,
						success: function(data) {
							log("Success: " + jQuery.toJSON(data));
							
							// ### open session: ###
							jsonAjax({
								url: opts.keyManagerUrl + "/Session/" + encodeURIComponent(opts.keyStoreId) + "/" +encodeURIComponent(opts.appServerID) + "/open",
								type: "POST",
								username: opts.username,
								password: opts.password,
								success: function(data) {
									log("Success: " + jQuery.toJSON(data));
									
									var cryptoSessionID = data.cryptoSessionID;
	
									// ### unlock session: ###
									jsonAjax({
										url: opts.keyManagerUrl + "/Session/" + encodeURIComponent(opts.keyStoreId) + "/" +encodeURIComponent(opts.appServerID) + "/" +encodeURIComponent(cryptoSessionID) + "/unlock",
										type: "POST",
										username: opts.username,
										password: opts.password,
										success: function(data) {
											log("Success: " + jQuery.toJSON(data));
											log("Session is unlocked.");
											opts.success.apply();									
											log("Work done.");
										},
										error: opts.error
									});
									
								},
								error: opts.error
							});
							
						},
						error: opts.error
					});
					
				},
				error: opts.error
			});		
		}
		
		var username = jQuery('#username').val();
		var password = jQuery('#password').val();
		log("Starting with username " + username);
		unlockOpts = {
			keyActivityPeriodMSec:"3600000",
			keyStorePeriodMSec:"86400000",
			keyStoreId: "mykeystoreid" + Math.random(),
			keyManagerUrl: "http://localhost:8686/org.cumulus4j.keymanager.front.webapp",
			appServerBaseURL: "http://localhost:8585/org.cumulus4j.integrationtest.webapp/org.cumulus4j.keymanager.back.webapp",
			appServerID: "appServer1",
			username: username,
			password: password,
			success: function() {
				log("Do work now!");
			},
			error: function() {
				alert("Error :-(");
			}
		};
		doInUnlockedSession(unlockOpts);
	});
});
</script>

</body>
</html>